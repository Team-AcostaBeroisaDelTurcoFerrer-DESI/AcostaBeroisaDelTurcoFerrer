<div class="acciones">
    <a th:href="@{/api/recetas/listado}">Listado de Recetas</a>
</div>

<form id="recetaForm">
    <label>Nombre:</label>
    <input type="text" name="nombre" required><br/>

    <label>Descripción:</label>
    <input type="text" name="descripcion" required><br/>

    <div id="ingredientesContainer"></div>

    <button type="button" onclick="agregarIngrediente()">Agregar Ingrediente</button><br/><br/>
    <button type="submit">Guardar Receta</button>
</form>

<template id="ingredienteTemplate">
    <div class="ingrediente">
        <label>Ingrediente:</label>
        <select class="ingredienteId" required>
            <option th:each="i : ${ingredientes}" th:value="${i.id}" th:text="${i.nombre}">Ingrediente</option>
        </select>

        <label>Cantidad:</label>
        <input type="number" step="0.1" class="cantidad" required>

        <label>Calorías:</label>
        <input type="number" class="calorias" required>
        <br/>
    </div>
</template>

<script>
    let ingredienteIndex = 0;

    function agregarIngrediente() {
        const template = document.getElementById("ingredienteTemplate");
        const clone = template.content.cloneNode(true);
        document.getElementById("ingredientesContainer").appendChild(clone);
        ingredienteIndex++;
    }

    document.getElementById("recetaForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const nombre = this.nombre.value;
        const descripcion = this.descripcion.value;

        const ingredientes = Array.from(document.querySelectorAll("#ingredientesContainer .ingrediente")).map(div => {
            return {
                ingredienteId: parseInt(div.querySelector(".ingredienteId").value),
                cantidad: parseFloat(div.querySelector(".cantidad").value),
                calorias: parseInt(div.querySelector(".calorias").value)
            };
        });

        const data = { nombre, descripcion, ingredientes };

        fetch("/api/recetas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                window.location.href = "/api/recetas/listado";
            } else {
                res.text().then(text => alert("Error: " + text));
            }
        });
    });

    window.onload = agregarIngrediente;
</script>
